<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Big File Uploader</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', sans-serif; }
body {
  height:100vh; display:flex; justify-content:center; align-items:center;
  background: linear-gradient(to bottom, #ff0000, #000000);
  color:#fff;
}
.upload-card {
  background: rgba(255,255,255,0.05); padding:40px 30px; border-radius:20px;
  box-shadow:0 15px 35px rgba(0,0,0,0.3); text-align:center; width:400px;
  backdrop-filter: blur(15px); transition: transform 0.3s;
}
.upload-card:hover { transform: scale(1.03); }
h1 { margin-bottom:25px; font-size:28px; text-shadow:0 3px 8px rgba(0,0,0,0.5); }
#fileInput { display:none; }
.file-label {
  display:block; padding:15px 20px; border-radius:12px; background: rgba(255,255,255,0.1);
  cursor:pointer; margin-bottom:20px; transition: background 0.3s;
}
.file-label:hover { background: rgba(255,255,255,0.2); }
button {
  padding:12px 30px; border:none; border-radius:12px; background:#ff0000;
  color:#fff; font-size:16px; cursor:pointer; transition:0.3s; margin-bottom:15px;
}
button:hover { background:#ff4d4d; }
.progress-container {
  width:100%; height:20px; background:rgba(255,255,255,0.1); border-radius:10px;
  overflow:hidden; margin-top:20px;
}
.progress-bar {
  height:100%; width:0; background: linear-gradient(90deg,#ff4d4d,#ff0000);
  transition: width 0.2s;
}
.status { margin-top:12px; font-size:14px; }
.drag-over { border:2px dashed #ff0000; }
</style>
</head>
<body>

<div class="upload-card" id="uploadCard">
<h1>Upload Your File</h1>
<label for="fileInput" class="file-label" id="fileLabel">Click or Drag & Drop a File Here</label>
<input type="file" id="fileInput" />
<button onclick="uploadFile()">Upload</button>
<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>
<div class="status" id="status"></div>
</div>

<script>
let CHUNK_SIZE = 5*1024*1024; // default 5MB
const MAX_CONCURRENT = 3;
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isChrome = /Chrome/.test(navigator.userAgent) && !isIOS;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
if(isIOS) CHUNK_SIZE=1*1024*1024;

let uploadedFiles = new Set();
const fileInput = document.getElementById("fileInput");
const progressBar = document.getElementById("progressBar");
const status = document.getElementById("status");

// Drag & drop
const uploadCard = document.getElementById('uploadCard');
uploadCard.addEventListener('dragover', e=>{ e.preventDefault(); uploadCard.classList.add('drag-over'); });
uploadCard.addEventListener('dragleave', ()=>{ uploadCard.classList.remove('drag-over'); });
uploadCard.addEventListener('drop', e=> {
  e.preventDefault(); uploadCard.classList.remove('drag-over');
  fileInput.files=e.dataTransfer.files;
  document.getElementById('fileLabel').textContent=fileInput.files[0].name;
});

fileInput.addEventListener('change', ()=> {
  const file=fileInput.files[0];
  if(file) document.getElementById('fileLabel').textContent=file.name;
});

// Upload function with Web Worker and ETA
async function uploadFile(){
  const file=fileInput.files[0];
  if(!file) return alert("No file selected");
  if(uploadedFiles.has(file.name)){ status.textContent="⚠️ Already uploaded"; return;}
  if(isIOS && file.size>500*1024*1024) alert("⚠️ iOS may have trouble with very large files.");

  const totalChunks=Math.ceil(file.size/CHUNK_SIZE);
  let uploadedBytes=0;
  const startTime=Date.now();

  // Engine hint logs
  if(isChrome) console.log("Optimized for V8 engine");
  if(isSafari || isIOS) console.log("Optimized for Nitro engine");

  // Spawn worker
  const worker=new Worker(URL.createObjectURL(new Blob([`
    self.onmessage=(e)=>{
      const {file, chunkSize}=e.data;
      const totalChunks=Math.ceil(file.size/chunkSize);
      for(let i=0;i<totalChunks;i++){
        const start=i*chunkSize;
        const end=Math.min(file.size,start+chunkSize);
        const chunk=file.slice(start,end);
        self.postMessage({chunk,index:i,totalChunks,fileName:file.name});
      }
    };
  `],{type:'text/javascript'})));

  worker.onmessage=async (e)=>{
    const {chunk,index,totalChunks,fileName}=e.data;
    const formData=new FormData();
    formData.append("chunk",chunk);
    formData.append("fileName",fileName);
    formData.append("index",index);
    formData.append("totalChunks",totalChunks);

    await fetch("/upload-chunk",{method:"POST",body:formData});

    // Update progress + ETA
    uploadedBytes+=chunk.size;
    const elapsed=(Date.now()-startTime)/1000;
    const speed=uploadedBytes/elapsed;
    const remaining=file.size-uploadedBytes;
    const etaSec=remaining/speed;
    const etaMin=Math.floor(etaSec/60);
    const etaSeconds=Math.round(etaSec%60);

    progressBar.style.width=Math.round((uploadedBytes/file.size)*100)+"%";
    status.textContent=`Uploading: ${Math.round((uploadedBytes/file.size)*100)}% | ETA: ${etaMin}m ${etaSeconds}s`;
  };

  worker.postMessage({file,chunkSize:CHUNK_SIZE});

  const checkCompletion=setInterval(()=>{
    if(uploadedBytes>=file.size){
      uploadedFiles.add(file.name);
      status.textContent="✅ Upload complete!";
      worker.terminate();
      clearInterval(checkCompletion);
    }
  },200);
}
</script>

</body>
</html>
